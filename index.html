<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Pez Animado</title>

<style>
  *{margin:0;padding:0;box-sizing:border-box;}
  body{
    width:100vw;
    height:100vh;
    overflow:hidden;
    background:black;
    position:relative;
  }
  #fondo{
    position:fixed;
    top:0;left:0;
    width:100%;height:100%;
    object-fit:cover;
    z-index:0;
  }
  #fish-wrapper{
    position:absolute;
    z-index:10;
    transform-origin:center center;
  }
</style>
</head>
<body>

<img id="fondo" src="peces/fondo.png">
<div id="fish-wrapper"></div>

<script>
/* -----------------------------
   CARGA DE IMÁGENES
--------------------------------*/
const pez=new Image();
const brillo=new Image();
const aleta=new Image();

pez.src="peces/pezprincipal.png";
brillo.src="peces/pezbrillo.png";
aleta.src="peces/pezaleta.png";

let loaded=0;
[pez,brillo,aleta].forEach(im=>{
  im.onload=()=>{
    loaded++;
    if(loaded===3){
      setupFish();
      initState();
      start();
      window.addEventListener("resize",setupFish);
    }
  }
});

/* -----------------------------
   LIENZO DEL PEZ
--------------------------------*/
let canvas,ctx;
let fishWidth,fishHeight,scaleFactor;

function setupFish(){
  if(!canvas){
    canvas=document.createElement("canvas");
    ctx=canvas.getContext("2d");
    document.getElementById("fish-wrapper").appendChild(canvas);
  }

  // MISMO TAMAÑO SIEMPRE
  const scale=0.25;

  fishWidth=window.innerWidth*scale;
  fishHeight=fishWidth*(pez.height/pez.width);

  canvas.width=fishWidth;
  canvas.height=fishHeight;

  scaleFactor=fishWidth/pez.width;

  drawFish();
}

/* -----------------------------
   ESTADO GLOBAL
--------------------------------*/
let time=0;
let last=null;

let xPos=0.3;
let horiz="drift"; 
let leftTarget=0.2;
let rightTarget=0.9;
let swimT=0;
let swimDur=10;
let swimStart=0.9;
let swimEnd=0.2;

let yPos=0.5;
let yState="rest";
let yTimer=0;
let yDur=5;
let yStart=0.5;
let yEnd=0.5;

/* Cola */
const TAIL_SLOW=0.16;
const TAIL_FAST=0.32;
let tailFreq=TAIL_SLOW;
let tailFreqTarget=TAIL_SLOW;
let tailPhase=0;
let tailScale=1;

/* Brillo */
let glowMode="low";
let glowVal=0.4;
let glowStart=0;
let glowDur=10;
let glowOsc=0;
let glowTrans=false;
let glowTransStart=0;
let glowTransDur=0;
let glowFrom=0;
let glowTo=0;

/* Aleta */
let finSpeed=1.3;       // velocidad real suavizada
let finSpeedTarget=1.3; // objetivo
const FIN_LERP=1.2;

/* Rotación del cuerpo */
let bodyRot=0;
let bodyRotTarget=0;
const ROT_LERP=1.5;

/* -----------------------------
   UTILIDADES
--------------------------------*/
function rand(a,b){return a+Math.random()*(b-a);}
function clamp01(v){return Math.max(0.2,Math.min(0.8,v));}
function ease(t){return t<0.5?2*t*t:1-Math.pow(-2*t+2,2)/2;}

/* -----------------------------
   INICIAR ESTADOS
--------------------------------*/
function initState(){
  glowDur=rand(7,17);

  leftTarget=rand(0.1,0.3);
  rightTarget=rand(0.83,0.93);

  swimStart=rightTarget;
  swimEnd=leftTarget;
  swimDur=rand(8,14);
  swimT=0;

  yPos=0.5;
  yStart=0.5;
  yEnd=0.5;
  yState="rest";
  yDur=rand(5,7);

  finSpeed=1.3;
  finSpeedTarget=1.3;
}

/* -----------------------------
   INICIO LOOP
--------------------------------*/
function start(){ requestAnimationFrame(loop); }

function loop(ts){
  if(!last) last=ts;
  const dt=(ts-last)/1000;
  last=ts;
  time+=dt;

  updateHorizontal(dt);
  updateVertical(dt);
  updateTail(dt);
  updateGlow(dt);
  updateFin(dt);
  updateBodyRotation(dt);

  drawFish();
  updateFishWrapper();

  requestAnimationFrame(loop);
}

/* -----------------------------
   HORIZONTAL
--------------------------------*/
const DRIFT=0.02;

function updateHorizontal(dt){
  if(horiz==="drift"){
    xPos+=DRIFT*dt;

    /* cuerpo ligeramente inclinado hacia abajo */
    bodyRotTarget=0.04;

    if(xPos>=rightTarget){
      xPos=rightTarget;
      horiz="swim";
      swimStart=xPos;
      swimEnd=leftTarget=rand(0.1,0.3);
      swimDur=rand(8,14);
      swimT=0;
      tailFreqTarget=TAIL_FAST;
    }

  } else {

    swimT+=dt/swimDur;
    const p=Math.min(1,swimT);
    const e=ease(p);
    xPos=swimStart+(swimEnd-swimStart)*e;

    /* cuerpo un poco inclinado hacia arriba */
    bodyRotTarget=-0.06;

    if(p>=1){
      horiz="drift";
      rightTarget=rand(0.83,0.93);
      tailFreqTarget=TAIL_SLOW;
    }
  }
}

/* -----------------------------
   VERTICAL
--------------------------------*/
function updateVertical(dt){
  if(yState==="rest"){
    yTimer+=dt;
    if(yTimer>=yDur){
      yState="move";
      yTimer=0;
      yDur=rand(2,2.8);

      yStart=yPos;
      let ny;
      do{ ny=clamp01(rand(0.2,0.8)); }
      while(Math.abs(ny-yPos)<0.1);
      yEnd=ny;
    }
  } else {
    yTimer+=dt;
    let t=Math.min(1,yTimer/yDur);
    const e=ease(t);
    yPos=yStart+(yEnd-yStart)*e;

    if(t>=1){
      yState="rest";
      yTimer=0;
      yDur=rand(5,7);
      yPos=yEnd;
    }
  }
}

/* -----------------------------
   COLA
--------------------------------*/
function updateTail(dt){
  const diff=tailFreqTarget-tailFreq;
  const step=1.2*dt;
  if(Math.abs(diff)<=step) tailFreq=tailFreqTarget;
  else tailFreq+=Math.sign(diff)*step;

  tailPhase+=dt*tailFreq;
  const w=(Math.sin(tailPhase*2*Math.PI)+1)/2;
  tailScale=0.6+w*0.4;
}

/* -----------------------------
   BRILLO
--------------------------------*/
const LOW_MIN=0.31,LOW_MAX=0.53,HIGH_MIN=0.75,HIGH_MAX=1.0;

function updateGlow(dt){
  if(glowTrans){
    let t=(time-glowTransStart)/glowTransDur;
    if(t>1) t=1;
    const e=ease(t);
    glowVal=glowFrom+(glowTo-glowFrom)*e;

    if(t>=1){
      glowTrans=false;
      glowStart=time;
    }
    return;
  }

  glowOsc+=dt/glowDur;
  if(glowOsc>1) glowOsc-=1;
  const w=(Math.sin(glowOsc*2*Math.PI)+1)/2;

  if(glowMode==="low"){
    glowVal=LOW_MIN+w*(LOW_MAX-LOW_MIN);

    if(time-glowStart>=glowDur){
      glowTrans=true;
      glowTransStart=time;
      glowTransDur=rand(0.5,1);
      glowFrom=glowVal;
      glowTo=HIGH_MIN;
      glowMode="high";
      glowDur=rand(3,5);
    }

  } else {
    glowVal=HIGH_MIN+w*(HIGH_MAX-HIGH_MIN);

    if(time-glowStart>=glowDur){
      glowTrans=true;
      glowTransStart=time;
      glowTransDur=rand(0.5,1);
      glowFrom=glowVal;
      glowTo=(LOW_MIN+LOW_MAX)/2;
      glowMode="low";
      glowDur=rand(7,17);
    }
  }
}

/* -----------------------------
   VELOCIDAD DE ALETA SUAVIZADA + LIMITADA
--------------------------------*/
function updateFin(dt){

  // velocidad objetivo más suave y más lenta
  const noise=
      Math.sin(time*0.35)*0.15 +
      Math.sin(time*0.88)*0.07;

  const movingBoost=(yState==="move")?1.25:1.0;

  finSpeedTarget = 1.2 * movingBoost + noise;

  // límite para que nunca sea muy rápida
  finSpeedTarget = Math.max(0.8, Math.min(1.6, finSpeedTarget));

  // transición suave
  const diff=finSpeedTarget-finSpeed;
  const step=FIN_LERP*dt;
  if(Math.abs(diff)<=step) finSpeed=finSpeedTarget;
  else finSpeed+=Math.sign(diff)*step;
}

/* -----------------------------
   ROTACIÓN SUAVE DEL CUERPO
--------------------------------*/
function updateBodyRotation(dt){
  const diff=bodyRotTarget-bodyRot;
  const step=ROT_LERP*dt;
  if(Math.abs(diff)<=step) bodyRot=bodyRotTarget;
  else bodyRot+=Math.sign(diff)*step;
}

/* -----------------------------
   ACTUALIZAR POSICIÓN EXTERNA
--------------------------------*/
function updateFishWrapper(){
  const fw=document.getElementById("fish-wrapper");

  const margin=window.innerWidth*0.03;
  let minX=margin;
  let maxX=window.innerWidth-fishWidth-margin;
  if(maxX<minX){ minX=maxX=(window.innerWidth-fishWidth)/2; }

  const x=minX+(maxX-minX)*xPos;
  const h=window.innerHeight-fishHeight;
  const y=h*yPos;

  fw.style.left=x+"px";
  fw.style.top=y+"px";

  fw.style.transform=`rotate(${bodyRot}rad)`;
}

/* -----------------------------
   DIBUJAR PEZ COMPLETO
--------------------------------*/
function drawFish(){
  ctx.clearRect(0,0,fishWidth,fishHeight);

  const srcW=pez.width;
  const srcH=pez.height;

  const split=0.6;
  const srcMid=srcW*split;
  const srcTail=srcW-srcMid;

  const dstMid=fishWidth*split;
  const dstTail=fishWidth-dstMid;

  ctx.drawImage(pez,0,0,srcMid,srcH,0,0,dstMid,fishHeight);

  const seg=14;
  const base=dstTail/seg;

  let sx=dstMid;
  for(let i=0;i<seg;i++){
    const u=i/seg;
    const u2=(i+1)/seg;

    const s0=srcMid+srcTail*u;
    const sw=srcTail*(u2-u);

    const fade=Math.pow(u,1.8);
    const sc=1+(tailScale-1)*fade;
    const dw=base*sc;

    ctx.drawImage(pez,s0,0,sw,srcH,sx,0,dw,fishHeight);
    sx+=dw;
  }

  /* BRILLO */
  ctx.save();
  ctx.globalAlpha=glowVal;

  ctx.drawImage(brillo,0,0,srcMid,srcH,0,0,dstMid,fishHeight);

  sx=dstMid;
  for(let i=0;i<seg;i++){
    const u=i/seg;
    const u2=(i+1)/seg;
    const s0=srcMid+srcTail*u;
    const sw=srcTail*(u2-u);
    const fade=Math.pow(u,1.8);
    const sc=1+(tailScale-1)*fade;
    const dw=base*sc;
    ctx.drawImage(brillo,s0,0,sw,srcH,sx,0,dw,fishHeight);
    sx+=dw;
  }
  ctx.restore();

  /* ALETA (más lenta y suave) */
  ctx.save();

  const aw=aleta.width*scaleFactor;
  const ah=aleta.height*scaleFactor;

  const left=fishWidth*0.26;
  const top=fishHeight*0.57;
  const px=left;
  const py=top+ah*0.5;

  ctx.translate(px,py);

  const angle=Math.sin(time*finSpeed)*0.28;
  ctx.rotate(angle);

  ctx.drawImage(aleta,0,-ah*0.5,aw,ah);

  ctx.restore();
}
</script>

</body>
</html>
